<!DOCTYPE html>
<html lang="en" data-app-version="v-2025-11-09-mobile-vertical">
<head>
  <meta charset="utf-8" />
  <title>ChamCong / Shift Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{
      --bg:#f6f7fb; --panel:#ffffff; --muted:#6b7280; --txt:#0f172a;
      --green:#16a34a; --red:#dc2626; --yellow:#eab308; --gray:#9ca3af; --border:#e5e7eb;
      --card:#fafafa; --btn:#0f172a; --btnh:#111827; --btn-txt:#ffffff; --accent:#4f46e5;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font:14px system-ui, Segoe UI, Roboto, Arial, sans-serif;}

    .shell{min-height:100%; display:flex; align-items:center; justify-content:center; padding:24px;}
    .app{display:none;}
    .authed .shell{display:block; padding:16px;}
    .authed .app{display:grid; grid-template-columns: 360px 1fr; gap:16px; align-items:start}

    .card{background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 6px 24px rgba(15,23,42,.06);}
    h2,h3{margin:0 0 12px 0}
    .muted{color:var(--muted)}
    label{display:block;margin:8px 0 6px 0;font-weight:600}
    input,select,button{border:1px solid var(--border); color:var(--txt); border-radius:10px; padding:12px 14px; width:100%; font-size:14px; background:#fff;}
    button{background:var(--btn); color:var(--btn-txt); cursor:pointer; font-weight:700;}
    button:hover{background:var(--btnh)}
    button[disabled]{opacity:.6; cursor:not-allowed}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    /* Desktop table grid */
    .grid{overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff; -webkit-overflow-scrolling: touch;}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:820px}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);border-right:1px solid var(--border)}
    th:first-child, td:first-child{position:sticky;left:0;background:#fff;z-index:2}
    thead th{position:sticky;top:0;background:#fff;z-index:3}
    td.cell{cursor:pointer;text-align:center;font-weight:600;border-left:1px solid var(--border);height:44px}
    td.cell.disabled{cursor:not-allowed; opacity:.7}

    /* Mobile vertical list */
    .mobile-list{display:none; border:1px solid var(--border); border-radius:12px; background:#fff;}
    .ml-head{padding:10px 12px; border-bottom:1px solid var(--border); font-weight:700;}
    .ml-row{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px; border-top:1px solid var(--border);}
    .ml-row:first-of-type{border-top:0;}
    .ml-left{display:flex; flex-direction:column; gap:2px;}
    .ml-date{font-weight:700;}
    .ml-dow{font-size:12px; color:var(--muted);}
    .ml-btn{min-width:140px; text-align:center; border-radius:999px; padding:10px 12px; font-weight:800; border:1px solid var(--border); cursor:pointer;}
    .ml-btn.disabled{opacity:.6; cursor:not-allowed}
    .ml-note{font-size:12px;color:var(--muted);margin-top:8px}

    .legend{display:flex;gap:10px;flex-wrap:wrap}
    .dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:6px}
    .pill{display:inline-flex;gap:6px;align-items:center;background:var(--card);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .rightpane{display:grid;gap:12px}
    .toolbar{display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap}
    .note{font-size:12px;color:var(--muted)}
    .foot{font-size:12px;color:var(--muted);margin-top:8px}
    .login-card{width:100%; max-width:520px;}
    .error{color:#b91c1c; font-weight:600; margin-top:8px}
    .status{color:#475569; margin-top:8px}

    .savebar{display:none; gap:8px; margin-top:8px; position:sticky; top:0; z-index:5;
      justify-content:flex-end; padding:8px; background:#ffffffcc; backdrop-filter:saturate(1.2) blur(2px);
      border:1px solid var(--border); border-radius:10px;}
    .savebar.show{display:flex;}
    .chip{background:#EEF2FF; color:#3730A3; border:1px solid #C7D2FE; padding:4px 8px; border-radius:999px; font-weight:700; font-size:12px;}

    .picker{position:fixed; z-index:9999; background:#fff; border:1px solid var(--border);
      border-radius:12px; box-shadow:0 12px 28px rgba(15,23,42,.18); padding:10px; display:none;}
    .picker .opt{display:inline-block; padding:8px 12px; margin:4px; border-radius:999px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:700; font-size:13px;}

    .badge-ro{display:none; align-items:center; gap:6px; font-weight:700; font-size:12px; color:#7c3aed; background:#f5f3ff; border:1px solid #ddd6fe; padding:6px 10px; border-radius:999px;}
    .show-ro .badge-ro{display:inline-flex;}

    @media (max-width: 880px){
      body{font-size:16px;}
      .authed .app{grid-template-columns:1fr; gap:12px}
      .card{padding:12px; border-radius:12px;}
      .toolbar{gap:6px}
      table{min-width:640px}
      th,td{padding:8px 10px}
      td.cell{height:48px}
      .pill{padding:4px 8px}
      .legend{gap:6px}
      .savebar{top: env(safe-area-inset-top, 0px);}
      .foot{font-size:11px}
    }
  </style>
</head>
<body>
  <!-- Login -->
  <div class="shell" id="shell">
    <div class="card login-card">
      <h2>Shift Registration</h2>

      <div id="classicLogin">
        <label>User ID (your <em>pname</em>)</label>
        <input id="uid" type="text" autocomplete="off" placeholder="e.g., BÃ¹i Quang Minh"/>
        <label>Password (your <em>person_id</em>)</label>
        <input id="pwd" type="password" autocomplete="new-password" placeholder="Enter your person_id"/>
        <button id="loginBtn" type="button" style="margin-top:10px" onclick="login()">Sign in</button>
        <div id="loginMsg" class="status" aria-live="polite"></div>
      </div>

      <div style="text-align:center; margin:10px 0; color:#94a3b8">â€” or â€”</div>

      <div style="text-align:center">
        <button type="button" onclick="loginWithGoogle()" style="background:#fff;color:#111827;border:1px solid var(--border)">
          Sign in with Google (student.vgu.edu.vn)
        </button>
      </div>
    </div>
  </div>

  <!-- App -->
  <div class="app" id="app" style="display:none">
    <div class="card">
      <h3>Setup</h3>
      <div style="display:grid;grid-template-columns:max-content 1fr;gap:8px;margin-top:8px">
        <div>Signed in:</div><div id="who"></div>
        <div>Role:</div><div id="role"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button type="button" onclick="logout()" style="background:#fff;color:#111827;border:1px solid var(--border)">Logout</button>
      </div>
      <hr/>
      <div class="toolbar">
        <div>
          <label>Week starting (Mon)</label>
          <input id="weekStart" type="date" />
          <div class="note">Loads Mondayâ€“Sunday for the selected week (GMT+7).</div>
        </div>
        <button type="button" onclick="loadWeek()">Load</button>
      </div>

      <!-- Member view toggle -->
      <div id="viewToggle" class="row" style="margin-top:8px; display:none">
        <input id="showAll" type="checkbox" onchange="renderGrid()" />
        <label for="showAll" style="margin:0">Show full matrix (read-only)</label>
      </div>

      <div style="margin:10px 0">
        <div class="legend">
          <span class="pill"><i class="dot" style="background:var(--green)"></i>Registered</span>
          <span class="pill"><i class="dot" style="background:var(--red)"></i>Busy</span>
          <span class="pill"><i class="dot" style="background:var(--yellow)"></i>Busy â€” In room</span>
          <span class="pill"><i class="dot" style="background:var(--gray)"></i>Blank</span>
        </div>
      </div>

      <div id="adminBar" style="display:none;margin-top:8px">
        <div class="pill" style="gap:10px">
          <input id="adminOverride" type="checkbox" onchange="toggleAdminEdit(this.checked)" />
          <label for="adminOverride" style="margin:0">Admin Edit Mode (ignores deadline & lets everyone edit)</label>
        </div>
        <div class="row" style="margin-top:8px">
          <button type="button" onclick="sendMonthly(event)">Send Monthly Reminders</button>
        </div>
      </div>
      <p class="foot">Members can edit only their own row while the week is open (until Sunday 23:59, Asia/Ho_Chi_Minh). Admins can always edit.</p>
    </div>

    <div class="rightpane">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="row" style="gap:10px;align-items:center">
            <h3>Weekly Matrix</h3>
            <span id="roBadge" class="badge-ro">ðŸ”’ Read-only</span>
          </div>
          <div class="savebar" id="savebar">
            <span class="chip" id="dirtyCount">0 changes</span>
            <button id="saveBtn" type="button" onclick="saveAll()" disabled>Save</button>
            <button type="button" onclick="discardAll()">Discard changes</button>
          </div>
        </div>

        <!-- Desktop grid -->
        <div id="grid" class="grid"></div>

        <!-- Mobile vertical list -->
        <div id="gridMobile" class="mobile-list" aria-hidden="true"></div>

        <p class="note">
          Click to cycle: Blank â†’ Registered â†’ Busy (then pick subtype). Admins can edit all; members can edit their own row when open.
        </p>
      </div>
    </div>
  </div>

  <!-- BUSY subtype picker -->
  <div id="picker" class="picker" onclick="event.stopPropagation()">
    <div>
      <span class="opt" data-sub="EXAM">EXAM</span>
      <span class="opt" data-sub="HOME">HOME</span>
      <span class="opt" data-sub="SICK">SICK</span>
      <span class="opt" data-sub="IN-ROOM">IN-ROOM</span>
      <span class="opt" data-sub="OTHER">OTHER</span>
    </div>
  </div>

<script>
const LS_KEY = 'chamcong:lastWeekStart';
let SESSION=null;
let CURRENT={days:[],users:[],data:{},colors:{},weekStartISO:null};
let STAGED={};
let PICKER_CTX=null;

function keyFor(u,d){return `${u}__${d}`;}
function updateSavebar(){
  const n=Object.keys(STAGED).length;
  document.getElementById('dirtyCount').textContent = n===1 ? '1 change' : `${n} changes`;
  const saveBtn = document.getElementById('saveBtn');
  const locked = (SESSION?.read_only && !SESSION?.is_admin);
  saveBtn.disabled = (n===0) || locked;
  const show = n>0 && !locked;
  document.getElementById('savebar').classList.toggle('show', show);
}

/* Toast for RO attempts */
function toastRO(){
  if (window.__ro_ts && Date.now()-window.__ro_ts<1500) return;
  window.__ro_ts = Date.now();
  const t=document.createElement('div');
  t.textContent='Read-only mode is ON.';
  Object.assign(t.style,{position:'fixed',left:'50%',bottom:'24px',transform:'translateX(-50%)',
    padding:'10px 14px',borderRadius:'10px',background:'#111827',color:'#fff',fontSize:'14px',
    boxShadow:'0 6px 20px rgba(0,0,0,.25)',zIndex:2147483647});
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),1600);
}

/* -------- Login UI state -------- */
function setLoginState(isLoading,msg,isError){
  const btn=document.getElementById('loginBtn');
  const box=document.getElementById('loginMsg');
  btn.disabled=!!isLoading;
  btn.textContent=isLoading?'Signing inâ€¦':'Sign in';
  btn.setAttribute('aria-busy', isLoading ? 'true' : 'false');
  box.textContent=msg || (isLoading?'Logging inâ€¦':'');
  box.className=isError?'error':'status';
}

/* -------- Classic login -------- */
function login(){
  const user_key=document.getElementById('uid').value.trim();
  const password=document.getElementById('pwd').value;
  if(!user_key||!password){ setLoginState(false,'Please enter both User ID and Password.',true); return; }
  setLoginState(true,'Logging inâ€¦',false);

  google.script.run
    .withSuccessHandler(res=>{
      if(!res||!res.ok){ setLoginState(false,(res&&res.error)||'Login failed',true); return; }
      finishLogin(res.data);
    })
    .withFailureHandler(()=> setLoginState(false,'INVALID CREDENTIALS',true))
    .route({action:'login', user_key, password});
}

/* -------- Google login -------- */
function loginWithGoogle(){
  const btn = event?.target;
  if (btn) { btn.disabled = true; btn.textContent = 'Signing inâ€¦'; }
  google.script.run
    .withSuccessHandler(res=>{
      if (btn) { btn.disabled = false; btn.textContent = 'Sign in with Google (student.vgu.edu.vn)'; }
      if(!res||!res.ok){ alert((res&&res.error)||'Google sign-in failed'); return; }
      finishLogin(res.data);
    })
    .withFailureHandler(()=>{
      if (btn) { btn.disabled = false; btn.textContent = 'Sign in with Google (student.vgu.edu.vn)'; }
      alert('Google sign-in failed');
    })
    .route({action:'loginWithGoogle'});
}

function finishLogin(d){
  SESSION = {
    user: d.user,
    is_admin: d.is_admin,
    admin_edit_override: !!d.admin_edit_override,
    read_only: !!d.read_only
  };
  document.body.classList.add('authed');
  document.getElementById('shell').style.display = 'none';
  document.getElementById('app').style.display   = '';

  document.getElementById('who').textContent  = `${d.user.name} (${d.user.user_id})`;
  document.getElementById('role').textContent = d.is_admin ? 'Admin' : 'Member';

  // Admin bar & member view toggle
  const adminBar      = document.getElementById('adminBar');
  const adminOverride = document.getElementById('adminOverride');
  const viewToggle    = document.getElementById('viewToggle');
  const showAll       = document.getElementById('showAll');

  if (d.is_admin) {
    adminBar.style.display = '';
    adminOverride.checked = !!d.admin_edit_override;
    viewToggle.style.display = 'none';        // admins always see all
    if (showAll) showAll.checked = true;
  } else {
    adminBar.style.display   = 'none';
    adminOverride.checked    = !!d.admin_edit_override; // ignored here
    viewToggle.style.display = '';
    if (showAll) showAll.checked = false;               // default: own row only
  }

  // initial week (remember last, else admins:this week, members:next week)
  let chosen = null;
  try { chosen = localStorage.getItem(LS_KEY) || null; } catch(e) {}
  if (!chosen) {
    const today  = new Date();
    const monday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const dow    = monday.getDay();
    monday.setDate(monday.getDate() + (dow === 0 ? -6 : 1 - dow));
    if (!d.is_admin && !d.admin_edit_override) monday.setDate(monday.getDate() + 7);
    chosen = monday.toISOString().slice(0,10);
  }
  document.getElementById('weekStart').value = chosen;
  try { localStorage.setItem(LS_KEY, chosen); } catch(e) {}

  reflectReadOnlyUI();
  loadWeek();
}

/* -------- Logout -------- */
function logout(){
  SESSION=null; STAGED={};
  document.getElementById('app').style.display='none';
  document.getElementById('shell').style.display='';
  document.body.classList.remove('authed');
  setLoginState(false,'',false);
  document.getElementById('uid').value='';
  document.getElementById('pwd').value='';
}

/* -------- Load week -------- */
function setGridLoading(on){
  document.getElementById('grid').innerHTML = on?'<div class="muted" style="padding:12px">Loading tableâ€¦</div>':'';
  document.getElementById('gridMobile').innerHTML = '';
}
function loadWeek(){
  STAGED={}; updateSavebar();
  const weekStartISO = document.getElementById('weekStart').value;
  try { localStorage.setItem(LS_KEY, weekStartISO); } catch(e){}
  setGridLoading(true);
  google.script.run.withSuccessHandler(res=>{
    setGridLoading(false);
    if(!res.ok){
      document.getElementById('grid').innerHTML=`<div class="error" style="padding:12px">${res.error||'Failed to load'}</div>`;
      return;
    }
    // Sync flags from server too
    CURRENT = res.data || {};
    if (typeof CURRENT.read_only === 'boolean') {
      SESSION.read_only = CURRENT.read_only;
    }
    renderGrid();
  }).route({action:'getWeek', weekStartISO});
}

/* -------- Helpers -------- */
function colorFor(status, subtype){
  status=(status||'').toUpperCase(); subtype=(subtype||'').toUpperCase();
  if(status==='REGISTERED') return 'var(--green)';
  if(status==='BUSY'&&subtype==='IN-ROOM') return 'var(--yellow)';
  if(status==='BUSY') return 'var(--red)';
  return 'var(--gray)';
}
function labelFor(status, subtype){
  status=(status||'').toUpperCase(); subtype=(subtype||'').toUpperCase();
  if(status==='OTHER'&&!subtype) return 'BLANK';
  if(status==='BUSY'&&subtype) return `BUSY (${subtype})`;
  return status||'BLANK';
}
function dowName(dISO){
  const d = new Date(dISO + 'T00:00:00');
  return ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()];
}
function isNarrow(){ return window.innerWidth <= 768; }

/* -------- Grid render (desktop + mobile) -------- */
function renderGrid(){
  if (!CURRENT.days || !CURRENT.days.length){
    document.getElementById('grid').innerHTML='<div class="muted" style="padding:12px">No data</div>';
    document.getElementById('gridMobile').innerHTML='';
    return;
  }
  const canSeeAll = SESSION?.is_admin || (document.getElementById('showAll')?.checked === true);
  const usersToRender = canSeeAll ? CURRENT.users : CURRENT.users.filter(u => u.user_id === SESSION?.user?.user_id);

  const useMobile = !canSeeAll && usersToRender.length === 1 && isNarrow();

  // Toggle containers
  document.getElementById('grid').style.display = useMobile ? 'none' : '';
  const gm = document.getElementById('gridMobile');
  gm.style.display = useMobile ? 'block' : 'none';
  gm.setAttribute('aria-hidden', useMobile ? 'false' : 'true');

  if (useMobile) {
    renderGridMobile(usersToRender[0]);
  } else {
    renderGridDesktop(usersToRender);
  }

  updateSavebar();
  reflectReadOnlyUI();
}

function renderGridDesktop(usersToRender){
  const g=document.getElementById('grid');
  let html='<table><thead><tr><th>Name</th>';
  CURRENT.days.forEach(d=> html+=`<th>${d}</th>`);
  html+='</tr></thead><tbody>';

  usersToRender.forEach(u=>{
    const isMine=SESSION?.user?.user_id===u.user_id;
    html+=`<tr data-uid="${u.user_id}"><td><b>${u.name}</b></td>`;
    CURRENT.days.forEach(d=>{
      const k=keyFor(u.user_id,d);
      const stage=STAGED[k];
      const base=(CURRENT.data[u.user_id]||{})[d]||{status:'OTHER',subtype:''};
      const cell=stage||base;
      const bg=colorFor(cell.status,cell.subtype);
      const label=labelFor(cell.status,cell.subtype);

      const lockedByRO = (SESSION?.read_only && !SESSION?.is_admin);
      const disabled = lockedByRO || !(SESSION?.is_admin || isMine);
      const cls=disabled?'cell disabled':'cell';
      const handler=disabled?'':`onclick="onCellClick(event,'${u.user_id}','${d}')"`;

      html+=`<td class="${cls}" style="background:${bg}" ${handler}>${label}</td>`;
    });
    html+='</tr>';
  });

  html+='</tbody></table>';
  g.innerHTML=html;
}

function renderGridMobile(user){
  const wrap = document.getElementById('gridMobile');

  let html = `<div class="ml-head">${user.name}</div>`;
  CURRENT.days.forEach(d=>{
    const k = keyFor(user.user_id,d);
    const base=(CURRENT.data[user.user_id]||{})[d]||{status:'OTHER',subtype:''};
    const cell=STAGED[k]||base;
    const label=labelFor(cell.status,cell.subtype);
    const bg=colorFor(cell.status,cell.subtype);

    const lockedByRO = (SESSION?.read_only && !SESSION?.is_admin);
    const disabled = lockedByRO ? 'disabled' : '';
    const handler = lockedByRO ? '' : `onclick="onCellClickMobile(event,'${user.user_id}','${d}')"`;

    html += `
      <div class="ml-row">
        <div class="ml-left">
          <div class="ml-date">${d}</div>
          <div class="ml-dow">${dowName(d)}</div>
        </div>
        <div class="ml-btn ${disabled}" style="background:${bg}; color:#fff;" ${handler}>
          ${label}
        </div>
      </div>`;
  });
  html += `<div class="ml-note">Tap the status pill to cycle. Busy opens subtype picker.</div>`;

  wrap.innerHTML = html;
}

/* Click cycle handlers */
function onCellClick(ev, user_id, dateISO) {
  ev.stopPropagation();
  hidePicker();

  if (SESSION?.read_only && !SESSION?.is_admin) { toastRO(); return; }

  const k = keyFor(user_id, dateISO);
  const base  = (CURRENT.data[user_id] || {})[dateISO] || {status:'OTHER', subtype:''};
  const cur   = STAGED[k] || base;
  const s = (cur.status || '').toUpperCase();

  if (s === 'OTHER') {
    STAGED[k] = { target_user_id:user_id, dateISO, status:'REGISTERED', subtype:'' };
    renderGrid(); updateSavebar();
  } else if (s === 'REGISTERED') {
    PICKER_CTX = { user_id, dateISO };
    openPicker(ev.clientX, ev.clientY);
  } else {
    STAGED[k] = { target_user_id:user_id, dateISO, status:'OTHER', subtype:'' };
    renderGrid(); updateSavebar();
  }
}
function onCellClickMobile(ev, user_id, dateISO){ onCellClick(ev, user_id, dateISO); }

/* Picker */
function openPicker(x,y){
  const p=document.getElementById('picker');
  const pad=8, w=220, h=p.offsetHeight||140;
  let left = x + pad, top = y + pad;
  const vw = window.innerWidth, vh = window.innerHeight;
  if (left + w > vw - pad) left = vw - w - pad;
  if (top + h > vh - pad) top = vh - h - pad;
  p.style.display='block'; p.style.left=left+'px'; p.style.top=top+'px';
}
function hidePicker(){document.getElementById('picker').style.display='none'; PICKER_CTX=null;}
document.addEventListener('click', hidePicker);
document.addEventListener('keydown', e=>{ if(e.key==='Escape') hidePicker(); });
document.querySelectorAll('#picker .opt').forEach(el=>{
  el.addEventListener('click', ()=>{
    if(!PICKER_CTX) return;
    if (SESSION?.read_only && !SESSION?.is_admin) { toastRO(); return; }
    const subtype=el.getAttribute('data-sub'); const {user_id,dateISO}=PICKER_CTX;
    const k=keyFor(user_id,dateISO);
    STAGED[k]={target_user_id:user_id,dateISO,status:'BUSY',subtype};
    hidePicker(); renderGrid(); updateSavebar();
  });
});

/* Save / Discard */
function saveAll(){
  if (SESSION?.read_only && !SESSION?.is_admin) { toastRO(); return; }
  const changes=Object.values(STAGED);
  if(!changes.length) return;
  const btn=document.getElementById('saveBtn');
  btn.disabled=true; btn.textContent='Savingâ€¦';
  const actor_id=SESSION?.user?.user_id;

  google.script.run.withSuccessHandler(res=>{
    btn.textContent='Save';
    if(!res.ok){ alert(res.error||'Save failed'); btn.disabled=false; return; }
    changes.forEach(c=>{
      CURRENT.data[c.target_user_id]=CURRENT.data[c.target_user_id]||{};
      CURRENT.data[c.target_user_id][c.dateISO]={status:c.status, subtype:c.subtype};
    });
    STAGED={}; updateSavebar(); renderGrid();
  }).withFailureHandler(err=>{
    btn.textContent='Save';
    btn.disabled=false;
    alert((err && err.message) || 'Save failed');
  }).route({action:'setStatusBatch', actor_id, changes});
}
function discardAll(){ STAGED={}; updateSavebar(); renderGrid(); }

/* Admin Edit toggle (server-backed) */
function toggleAdminEdit(on){
  const me = SESSION?.user?.user_id;
  google.script.run
    .withSuccessHandler(res=>{
      if(!res.ok){ alert(res.error||'Failed'); return; }
      SESSION.admin_edit_override = !!res.data.admin_edit_override;
      const cb = document.getElementById('adminOverride');
      if (cb) cb.checked = SESSION.admin_edit_override;
      renderGrid();
    })
    .withFailureHandler(err=>{
      // Revert checkbox on error
      const cb = document.getElementById('adminOverride');
      if (cb) cb.checked = !!SESSION?.admin_edit_override;
      alert((err && err.message) || 'Failed to toggle Admin Edit Mode');
    })
    .route({action:'toggleAdminEdit', actor_id: me, on: !!on});
}

/* Monthly reminders (manual trigger, robust) */
function sendMonthly(ev){
  const ym=prompt('Send reminders for YYYY-MM (leave blank to send for previous month):','');
  let year=null,month=null;
  if(ym&&/^\d{4}-\d{2}$/.test(ym)){year=+ym.slice(0,4);month=+ym.slice(5);}
  const btn = ev?.target;
  if (btn && btn.tagName==='BUTTON') btn.disabled = true;

  google.script.run.withSuccessHandler(res=>{
    if (btn) btn.disabled = false;
    if(!res.ok){ alert(res.error||'Failed'); return; }
    alert(res.data.message||'Done');
  }).withFailureHandler(err=>{
    if (btn) btn.disabled = false;
    alert((err && err.message) || 'Failed to send reminders');
  }).route({action:'sendMonthlyReminders', year, month});
}

/* Read-only badge + savebar visibility */
function reflectReadOnlyUI(){
  const badge = document.getElementById('roBadge');
  const appCard = badge?.closest('.card');
  const isRO = !!(SESSION?.read_only);
  if (badge && appCard) { appCard.classList.toggle('show-ro', isRO); }
  updateSavebar();
}

/* Member view label patch */
(function () {
  const wrap = document.getElementById('viewToggle');
  const cb   = document.getElementById('showAll');
  if (!wrap || !cb) return;

  let lbl = wrap.querySelector('label[for="showAll"]');
  if (!lbl) {
    lbl = document.createElement('label');
    lbl.htmlFor = 'showAll';
    wrap.appendChild(lbl);
  }
  wrap.style.gap = '8px';
  cb.title = 'Show the full matrix (read-only). When off, you only see your own row.';
  cb.setAttribute('aria-label', 'Toggle to view everyone (read-only)');

  const update = () => {
    lbl.style.margin = '0';
    lbl.textContent = cb.checked
      ? 'Showing everyone (read-only)'
      : 'Show full matrix (read-only)';
    renderGrid(); // re-render when toggled to swap layouts if needed
  };

  cb.addEventListener('change', update);
  update();
})();

/* Re-render on resize to switch layouts dynamically */
window.addEventListener('resize', () => { if (SESSION) renderGrid(); });
</script>
</body>
</html>
