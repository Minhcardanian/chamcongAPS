<!DOCTYPE html>
<html lang="en" data-app-version="v-2025-11-04-mobile">
<head>
  <meta charset="utf-8" />
  <title>ChamCong / Shift Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{
      --bg:#f6f7fb; --panel:#ffffff; --muted:#6b7280; --txt:#0f172a;
      --green:#16a34a; --red:#dc2626; --yellow:#eab308; --gray:#9ca3af; --border:#e5e7eb;
      --card:#fafafa; --btn:#0f172a; --btnh:#111827; --btn-txt:#ffffff; --accent:#4f46e5;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font:14px system-ui, Segoe UI, Roboto, Arial, sans-serif;}

    .shell{min-height:100%; display:flex; align-items:center; justify-content:center; padding:24px;}
    .app{display:none;}
    .authed .shell{display:block; padding:16px;}
    .authed .app{display:grid; grid-template-columns: 360px 1fr; gap:16px; align-items:start}

    .card{background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 6px 24px rgba(15,23,42,.06);}
    h2,h3{margin:0 0 12px 0}
    .muted{color:var(--muted)}
    label{display:block;margin:8px 0 6px 0;font-weight:600}
    input,select,button{border:1px solid var(--border); color:var(--txt); border-radius:10px; padding:12px 14px; width:100%; font-size:14px; background:#fff;}
    button{background:var(--btn); color:var(--btn-txt); cursor:pointer; font-weight:700;}
    button:hover{background:var(--btnh)}
    button[disabled]{opacity:.6; cursor:not-allowed}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    .grid{overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff; -webkit-overflow-scrolling: touch;}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:820px}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);border-right:1px solid var(--border)}
    th:first-child, td:first-child{position:sticky;left:0;background:#fff;z-index:2}
    thead th{position:sticky;top:0;background:#fff;z-index:3}
    td.cell{cursor:pointer;text-align:center;font-weight:600;border-left:1px solid var(--border);height:44px}
    td.cell.disabled{cursor:not-allowed; opacity:.7}

    .legend{display:flex;gap:10px;flex-wrap:wrap}
    .dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:6px}
    .pill{display:inline-flex;gap:6px;align-items:center;background:var(--card);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .rightpane{display:grid;gap:12px}
    .toolbar{display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap}
    .note{font-size:12px;color:var(--muted)}
    .foot{font-size:12px;color:var(--muted);margin-top:8px}
    .login-card{width:100%; max-width:520px;}
    .error{color:#b91c1c; font-weight:600; margin-top:8px}
    .status{color:#475569; margin-top:8px}

    .savebar{display:none; gap:8px; margin-top:8px; position:sticky; top:0; z-index:5;
      justify-content:flex-end; padding:8px; background:#ffffffcc; backdrop-filter:saturate(1.2) blur(2px);
      border:1px solid var(--border); border-radius:10px;}
    .savebar.show{display:flex;}
    .chip{background:#EEF2FF; color:#3730A3; border:1px solid #C7D2FE; padding:4px 8px; border-radius:999px; font-weight:700; font-size:12px;}

    .picker{position:fixed; z-index:9999; background:#fff; border:1px solid var(--border);
      border-radius:12px; box-shadow:0 12px 28px rgba(15,23,42,.18); padding:10px; display:none;}
    .picker .opt{display:inline-block; padding:8px 12px; margin:4px; border-radius:999px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:700; font-size:13px;}

    .badge-ro{display:none; align-items:center; gap:6px; font-weight:700; font-size:12px; color:#7c3aed; background:#f5f3ff; border:1px solid #ddd6fe; padding:6px 10px; border-radius:999px;}
    .show-ro .badge-ro{display:inline-flex;}

    @media (max-width: 880px){
      body{font-size:16px;}
      .authed .app{grid-template-columns:1fr; gap:12px}
      .card{padding:12px; border-radius:12px;}
      .toolbar{gap:6px}
      table{min-width:640px}
      th,td{padding:8px 10px}
      td.cell{height:48px}
      .pill{padding:4px 8px}
      .legend{gap:6px}
      .savebar{top: env(safe-area-inset-top, 0px);}
      .foot{font-size:11px}
    }
  </style>
</head>
<body>
  <!-- Login -->
  <div class="shell" id="shell">
    <div class="card login-card">
      <h2>Shift Registration</h2>

      <div id="classicLogin">
        <label>User ID (your <em>pname</em>)</label>
        <input id="uid" type="text" autocomplete="off" placeholder="e.g., BÃ¹i Quang Minh"/>
        <label>Password (your <em>person_id</em>)</label>
        <input id="pwd" type="password" autocomplete="new-password" placeholder="Enter your person_id"/>
        <button id="loginBtn" type="button" style="margin-top:10px" onclick="login()">Sign in</button>
        <div id="loginMsg" class="status" aria-live="polite"></div>
      </div>

      <div style="text-align:center; margin:10px 0; color:#94a3b8">â€” or â€”</div>

      <div style="text-align:center">
        <button type="button" onclick="loginWithGoogle()" style="background:#fff;color:#111827;border:1px solid var(--border)">
          Sign in with Google (student.vgu.edu.vn)
        </button>
      </div>
    </div>
  </div>

  <!-- App -->
  <div class="app" id="app" style="display:none">
    <div class="card">
      <h3>Setup</h3>
      <div style="display:grid;grid-template-columns:max-content 1fr;gap:8px;margin-top:8px">
        <div>Signed in:</div><div id="who"></div>
        <div>Role:</div><div id="role"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button type="button" onclick="logout()" style="background:#fff;color:#111827;border:1px solid var(--border)">Logout</button>
      </div>
      <hr/>
      <div class="toolbar">
        <div>
          <label>Week starting (Mon)</label>
          <input id="weekStart" type="date" />
          <div class="note">Loads Mondayâ€“Sunday for the selected week.</div>
        </div>
        <button type="button" onclick="loadWeek()">Load</button>
      </div>

      <!-- Member view toggle -->
      <div id="viewToggle" class="row" style="margin-top:8px; display:none">
        <input id="showAll" type="checkbox" onchange="renderGrid()" />
        <label for="showAll" style="margin:0">Show full matrix (read-only)</label>
      </div>

      <div style="margin:10px 0">
        <div class="legend">
          <span class="pill"><i class="dot" style="background:var(--green)"></i>Registered</span>
          <span class="pill"><i class="dot" style="background:var(--red)"></i>Busy</span>
          <span class="pill"><i class="dot" style="background:var(--yellow)"></i>Busy â€” In room</span>
          <span class="pill"><i class="dot" style="background:var(--gray)"></i>Blank</span>
        </div>
      </div>

      <div id="adminBar" style="display:none;margin-top:8px">
        <div class="pill" style="gap:10px">
          <input id="adminOverride" type="checkbox" onchange="toggleAdminEdit(this.checked)" />
          <label for="adminOverride" style="margin:0">Admin Edit Mode (ignores deadline & lets everyone edit)</label>
        </div>
        <div class="pill" style="gap:10px; margin-top:8px">
          <input id="matrixRO" type="checkbox" onchange="toggleMatrixRO(this.checked)" />
          <label for="matrixRO" style="margin:0">Matrix Read-Only (members cannot edit)</label>
        </div>
        <div class="row" style="margin-top:8px">
          <button type="button" onclick="sendMonthly()">Send Monthly Reminders</button>
        </div>
      </div>
      <p class="foot">Members can edit only their own row while the week is open (until Sunday 23:59). Admins can always edit. When Read-Only is ON, members cannot edit.</p>
    </div>

    <div class="rightpane">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="row" style="gap:10px;align-items:center">
            <h3>Weekly Matrix</h3>
            <span id="roBadge" class="badge-ro">ðŸ”’ Read-only</span>
          </div>
          <div class="savebar" id="savebar">
            <span class="chip" id="dirtyCount">0 changes</span>
            <button id="saveBtn" type="button" onclick="saveAll()" disabled>Save</button>
            <button type="button" onclick="discardAll()">Discard changes</button>
          </div>
        </div>

        <div id="grid" class="grid"></div>

        <p class="note">
          Click a cell to cycle: Blank â†’ Registered â†’ Busy (then pick subtype). Admins can edit all; members can edit their own row when open.
        </p>
      </div>
    </div>
  </div>

  <!-- BUSY subtype picker -->
  <div id="picker" class="picker" onclick="event.stopPropagation()">
    <div>
      <span class="opt" data-sub="EXAM">EXAM</span>
      <span class="opt" data-sub="HOME">HOME</span>
      <span class="opt" data-sub="SICK">SICK</span>
      <span class="opt" data-sub="IN-ROOM">IN-ROOM</span>
      <span class="opt" data-sub="OTHER">OTHER</span>
    </div>
  </div>

<script>
const LS_KEY = 'chamcong:lastWeekStart';
let SESSION=null;
let CURRENT={days:[],users:[],data:{},colors:{},weekStartISO:null, read_only:false};
let STAGED={};
let PICKER_CTX=null;

/* ====== Unsaved-changes protection on week switch / page exit ====== */
const AUTOSAVE_ON_WEEK_SWITCH = false; // set true to silently save before switching

function hasDirty(){ return Object.keys(STAGED).length > 0; }

/* Toasts */
function toast(msg, ms=1400){
  const t=document.createElement('div');
  t.textContent=msg;
  Object.assign(t.style,{position:'fixed',left:'50%',bottom:'24px',transform:'translateX(-50%)',
    padding:'10px 14px',borderRadius:'10px',background:'#111827',color:'#fff',fontSize:'14px',
    boxShadow:'0 6px 20px rgba(0,0,0,.25)',zIndex:2147483647});
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),ms);
}
function toastRO(){ toast('Read-only mode is ON.'); }

/* Monday normalizer */
function toMondayISO(iso){
  // iso = yyyy-mm-dd, any day â†’ return that week's Monday as yyyy-mm-dd
  if(!iso) return iso;
  const [y,m,d]=iso.split('-').map(Number);
  const dt=new Date(y,m-1,d);
  const dow=dt.getDay(); // 0..6, Sun=0
  const diff=(dow===0?-6:1-dow);
  dt.setDate(dt.getDate()+diff);
  const pad=n=>String(n).padStart(2,'0');
  return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`;
}

/* Save helper that RELOADS from server after commit */
function saveAllThen(cb){
  const changes = Object.values(STAGED);
  if (!changes.length) { cb && cb(); return; }
  if (SESSION?.read_only && !SESSION?.is_admin) { toastRO(); return; }

  const btn = document.getElementById('saveBtn');
  if (btn) { btn.disabled = true; btn.textContent = 'Savingâ€¦'; }
  const actor_id = SESSION?.user?.user_id;

  google.script.run.withSuccessHandler(res=>{
    if (btn) btn.textContent='Save';
    if(!res.ok){ alert(res.error||'Save failed'); if (btn) btn.disabled=false; return; }

    // After successful commit, clear staged and reload authoritative data
    STAGED={}; updateSavebar();
    const weekISO = toMondayISO(document.getElementById('weekStart').value || CURRENT.weekStartISO);
    _performLoadWeek(weekISO);  // server read
    toast('Saved', 900);
    cb && cb();
  }).route({action:'setStatusBatch', actor_id, changes});
}

window.addEventListener('beforeunload', (e)=>{
  if (!hasDirty()) return;
  e.preventDefault();
  e.returnValue = '';
});

/* ====== Helpers ====== */
function keyFor(u,d){return `${u}__${d}`;}
function updateSavebar(){
  const n=Object.keys(STAGED).length;
  document.getElementById('dirtyCount').textContent = n===1 ? '1 change' : `${n} changes`;
  const saveBtn = document.getElementById('saveBtn');
  saveBtn.disabled = (n===0) || (SESSION?.read_only && !SESSION?.is_admin);
  const show = n>0 && !(SESSION?.read_only && !SESSION?.is_admin);
  document.getElementById('savebar').classList.toggle('show', show);
}

/* -------- Login UI state -------- */
function setLoginState(isLoading,msg,isError){
  const btn=document.getElementById('loginBtn');
  const box=document.getElementById('loginMsg');
  btn.disabled=!!isLoading;
  btn.textContent=isLoading?'Signing inâ€¦':'Sign in';
  btn.setAttribute('aria-busy', isLoading ? 'true' : 'false');
  box.textContent=msg || (isLoading?'Logging inâ€¦':'');
  box.className=isError?'error':'status';
}

/* -------- Classic login -------- */
function login(){
  const user_key=document.getElementById('uid').value.trim();
  const password=document.getElementById('pwd').value;
  if(!user_key||!password){ setLoginState(false,'Please enter both User ID and Password.',true); return; }
  setLoginState(true,'Logging inâ€¦',false);

  google.script.run
    .withSuccessHandler(res=>{
      if(!res||!res.ok){ setLoginState(false,(res&&res.error)||'Login failed',true); return; }
      finishLogin(res.data);
    })
    .withFailureHandler(()=> setLoginState(false,'INVALID CREDENTIALS',true))
    .route({action:'login', user_key, password});
}

/* -------- Google login -------- */
function loginWithGoogle(){
  const btn = event?.target;
  if (btn) { btn.disabled = true; btn.textContent = 'Signing inâ€¦'; }
  google.script.run
    .withSuccessHandler(res=>{
      if (btn) { btn.disabled = false; btn.textContent = 'Sign in with Google (student.vgu.edu.vn)'; }
      if(!res||!res.ok){ alert((res&&res.error)||'Google sign-in failed'); return; }
      finishLogin(res.data);
    })
    .withFailureHandler(()=>{
      if (btn) { btn.disabled = false; btn.textContent = 'Sign in with Google (student.vgu.edu.vn)'; }
      alert('Google sign-in failed');
    })
    .route({action:'loginWithGoogle'});
}

function finishLogin(d){
  SESSION = {
    user: d.user,
    is_admin: d.is_admin,
    admin_edit_override: !!d.admin_edit_override,
    read_only: !!d.read_only
  };
  document.body.classList.add('authed');
  document.getElementById('shell').style.display = 'none';
  document.getElementById('app').style.display   = '';

  document.getElementById('who').textContent  = `${d.user.name} (${d.user.user_id})`;
  document.getElementById('role').textContent = d.is_admin ? 'Admin' : 'Member';

  const adminBar      = document.getElementById('adminBar');
  const adminOverride = document.getElementById('adminOverride');
  const viewToggle    = document.getElementById('viewToggle');
  const showAll       = document.getElementById('showAll');
  const matrixRO      = document.getElementById('matrixRO');

  if (d.is_admin) {
    adminBar.style.display = '';
    adminOverride.checked = !!d.admin_edit_override;
    matrixRO.checked = !!SESSION.read_only;
    viewToggle.style.display = 'none';
    if (showAll) showAll.checked = true;
  } else {
    adminBar.style.display   = 'none';
    adminOverride.checked    = !!d.admin_edit_override;
    viewToggle.style.display = '';
    if (showAll) showAll.checked = false;
  }

  // initial week (remember last, else admins:this week, members:next week)
  let chosen = null;
  try { chosen = localStorage.getItem(LS_KEY) || null; } catch(e) {}
  if (!chosen) {
    const today  = new Date();
    const monday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const dow    = monday.getDay();
    monday.setDate(monday.getDate() + (dow === 0 ? -6 : 1 - dow));
    if (!d.is_admin && !d.admin_edit_override) monday.setDate(monday.getDate() + 7);
    chosen = monday.toISOString().slice(0,10);
  }
  document.getElementById('weekStart').value = chosen;
  try { localStorage.setItem(LS_KEY, chosen); } catch(e) {}

  reflectReadOnlyUI();
  loadWeek();
}

/* -------- Logout -------- */
function logout(){
  SESSION=null; STAGED={};
  document.getElementById('app').style.display='none';
  document.getElementById('shell').style.display='';
  document.body.classList.remove('authed');
  setLoginState(false,'',false);
  document.getElementById('uid').value='';
  document.getElementById('pwd').value='';
}

/* -------- Load week (with Monday snap + dirty-guard) -------- */
function setGridLoading(on){
  document.getElementById('grid').innerHTML = on?'<div class="muted" style="padding:12px">Loading tableâ€¦</div>':'';
}

function _performLoadWeek(weekStartISO){
  try { localStorage.setItem(LS_KEY, weekStartISO); } catch(e){}
  // Make sure the input also shows the normalized Monday
  document.getElementById('weekStart').value = weekStartISO;

  setGridLoading(true);
  google.script.run.withSuccessHandler(res=>{
    setGridLoading(false);
    if(!res.ok){
      document.getElementById('grid').innerHTML=`<div class="error" style="padding:12px">${res.error||'Failed to load'}</div>`;
      return;
    }
    CURRENT = Object.assign({read_only:false, weekStartISO}, res.data || {});
    if (typeof CURRENT.read_only === 'boolean') {
      SESSION.read_only = CURRENT.read_only;
      const ro = document.getElementById('matrixRO');
      if (ro && SESSION.is_admin) ro.checked = SESSION.read_only;
      reflectReadOnlyUI();
    }
    STAGED={}; updateSavebar(); renderGrid();
  }).route({action:'getWeek', weekStartISO});
}

function loadWeek(){
  const picked = document.getElementById('weekStart').value || '';
  const weekStartISO = toMondayISO(picked);
  if (!hasDirty()) { _performLoadWeek(weekStartISO); return; }

  if (AUTOSAVE_ON_WEEK_SWITCH) {
    saveAllThen(()=> _performLoadWeek(weekStartISO));
  } else {
    const ok = confirm('You have unsaved changes. Save them before switching weeks?');
    if (ok) saveAllThen(()=> _performLoadWeek(weekStartISO));
    // If cancelled, stay on current week and keep STAGED.
  }
}

/* -------- Grid render & interaction -------- */
function colorFor(status, subtype){
  status=(status||'').toUpperCase(); subtype=(subtype||'').toUpperCase();
  if(status==='REGISTERED') return 'var(--green)';
  if(status==='BUSY'&&subtype==='IN-ROOM') return 'var(--yellow)';
  if(status==='BUSY') return 'var(--red)';
  return 'var(--gray)';
}
function labelFor(status, subtype){
  status=(status||'').toUpperCase(); subtype=(subtype||'').toUpperCase();
  if(status==='OTHER'&&!subtype) return 'BLANK';
  if(status==='BUSY'&&subtype) return `BUSY (${subtype})`;
  return status||'BLANK';
}

function renderGrid(){
  const g=document.getElementById('grid');
  if(!CURRENT.days.length){ g.innerHTML='<div class="muted" style="padding:12px">No data</div>'; return; }

  const canSeeAll = SESSION?.is_admin || (document.getElementById('showAll')?.checked === true);

  const usersToRender = canSeeAll
    ? CURRENT.users
    : CURRENT.users.filter(u => u.user_id === SESSION?.user?.user_id);

  let html='<table><thead><tr><th>Name</th>';
  CURRENT.days.forEach(d=> html+=`<th>${d}</th>`);
  html+='</tr></thead><tbody>';

  usersToRender.forEach(u=>{
    const isMine=SESSION?.user?.user_id===u.user_id;
    html+=`<tr data-uid="${u.user_id}"><td><b>${u.name}</b></td>`;
    CURRENT.days.forEach(d=>{
      const k=keyFor(u.user_id,d);
      const stage=STAGED[k];
      const base=(CURRENT.data[u.user_id]||{})[d]||{status:'OTHER',subtype:''};
      const cell=stage||base;
      const bg=colorFor(cell.status,cell.subtype);
      const label=labelFor(cell.status,cell.subtype);

      const lockedByRO = (SESSION?.read_only && !SESSION?.is_admin);
      const disabled = lockedByRO || !(SESSION?.is_admin || isMine);
      const cls=disabled?'cell disabled':'cell';
      const handler=disabled?'':`onclick="onCellClick(event,'${u.user_id}','${d}')"`;

      html+=`<td class="${cls}" style="background:${bg}" ${handler}>${label}</td>`;
    });
    html+='</tr>';
  });

  html+='</tbody></table>';
  g.innerHTML=html;

  updateSavebar();
  reflectReadOnlyUI();
}

/* Click cycle: BLANK â†’ REGISTERED â†’ BUSY â†’ BLANK */
function onCellClick(ev, user_id, dateISO) {
  ev.stopPropagation();
  hidePicker();

  if (SESSION?.read_only && !SESSION?.is_admin) { toastRO(); return; }

  const k = keyFor(user_id, dateISO);
  const base  = (CURRENT.data[user_id] || {})[dateISO] || {status:'OTHER', subtype:''};
  const cur   = STAGED[k] || base;
  const s = (cur.status || '').toUpperCase();

  if (s === 'OTHER') {
    STAGED[k] = { target_user_id:user_id, dateISO, status:'REGISTERED', subtype:'' };
    renderGrid(); updateSavebar();
  } else if (s === 'REGISTERED') {
    PICKER_CTX = { user_id, dateISO };
    openPicker(ev.clientX, ev.clientY);
  } else {
    STAGED[k] = { target_user_id:user_id, dateISO, status:'OTHER', subtype:'' };
    renderGrid(); updateSavebar();
  }
}

/* Picker */
function openPicker(x,y){
  const p=document.getElementById('picker');
  const pad=8, w=220, h=p.offsetHeight||140;
  let left = x + pad, top = y + pad;
  const vw = window.innerWidth, vh = window.innerHeight;
  if (left + w > vw - pad) left = vw - w - pad;
  if (top + h > vh - pad) top = vh - h - pad;
  p.style.display='block'; p.style.left=left+'px'; p.style.top=top+'px';
}
function hidePicker(){document.getElementById('picker').style.display='none'; PICKER_CTX=null;}
document.addEventListener('click', hidePicker);
document.addEventListener('keydown', e=>{ if(e.key==='Escape') hidePicker(); });
document.querySelectorAll('#picker .opt').forEach(el=>{
  el.addEventListener('click', ()=>{
    if(!PICKER_CTX) return;
    if (SESSION?.read_only && !SESSION?.is_admin) { toastRO(); return; }
    const subtype=el.getAttribute('data-sub'); const {user_id,dateISO}=PICKER_CTX;
    const k=keyFor(user_id,dateISO);
    STAGED[k]={target_user_id:user_id,dateISO,status:'BUSY',subtype};
    hidePicker(); renderGrid(); updateSavebar();
  });
});

/* Save / Discard */
function saveAll(){
  if (SESSION?.read_only && !SESSION?.is_admin) { toastRO(); return; }
  if (!hasDirty()) return;
  const btn=document.getElementById('saveBtn');
  btn.disabled=true; btn.textContent='Savingâ€¦';

  // Delegate to the unified helper that reloads after save
  saveAllThen(()=>{ if (btn) { btn.disabled=false; btn.textContent='Save'; } });
}
function discardAll(){ STAGED={}; updateSavebar(); renderGrid(); }

/* Admin toggle mirrors server; keep SESSION in sync */
function toggleAdminEdit(on){
  const me = SESSION?.user?.user_id;
  google.script.run.withSuccessHandler(res=>{
    if(!res.ok){ alert(res.error||'Failed'); return; }
    SESSION.admin_edit_override = !!res.data.admin_edit_override;
    const cb = document.getElementById('adminOverride');
    if (cb) cb.checked = SESSION.admin_edit_override;
    renderGrid();
  }).route({action:'toggleAdminEdit', actor_id: me, on: !!on});
}

/* Admin: Matrix Read-Only toggle (server-backed) */
function toggleMatrixRO(on){
  const me = SESSION?.user?.user?.user_id || SESSION?.user?.user_id;
  google.script.run.withSuccessHandler(res=>{
    if(!res.ok){ alert(res.error||'Failed'); return; }
    SESSION.read_only = !!res.data.read_only;
    const ro = document.getElementById('matrixRO'); if (ro) ro.checked = SESSION.read_only;
    reflectReadOnlyUI();
    renderGrid();
  }).route({action:'setMatrixRO', actor_id: me, on: !!on});
}

/* Monthly reminders (manual trigger) */
function sendMonthly(){
  const ym=prompt('Send reminders for YYYY-MM (leave blank to send for previous month):','');
  let year=null,month=null; if(ym&&/^\d{4}-\d{2}$/.test(ym)){year=+ym.slice(0,4);month=+ym.slice(5);}
  const btns=document.querySelectorAll('button'); btns.forEach(b=>b.disabled=true);
  google.script.run.withSuccessHandler(res=>{
    btns.forEach(b=>b.disabled=false);
    if(!res.ok){ alert(res.error||'Failed'); return; }
    alert(res.data.message||'Done');
  }).route({action:'sendMonthlyReminders', year, month});
}

/* Read-only badge + savebar visibility */
function reflectReadOnlyUI(){
  const badge = document.getElementById('roBadge');
  const appCard = badge?.closest('.card');
  const isRO = !!(SESSION?.read_only);
  if (badge && appCard) {
    appCard.classList.toggle('show-ro', isRO);
  }
  updateSavebar();
}

/* Member view label patch (unchanged behavior) */
(function () {
  const wrap = document.getElementById('viewToggle');
  const cb   = document.getElementById('showAll');
  if (!wrap || !cb) return;

  let lbl = wrap.querySelector('label[for="showAll"]');
  if (!lbl) {
    lbl = document.createElement('label');
    lbl.htmlFor = 'showAll';
    wrap.appendChild(lbl);
  }
  wrap.style.gap = '8px';
  cb.title = 'Show the full matrix (read-only). When off, you only see your own row.';
  cb.setAttribute('aria-label', 'Toggle to view everyone (read-only)');

  const update = () => {
    lbl.style.margin = '0';
    lbl.textContent = cb.checked
      ? 'Showing everyone (read-only)'
      : 'Show full matrix (read-only)';
  };

  cb.addEventListener('change', update);
  update();
})();
</script>
</body>
</html>
