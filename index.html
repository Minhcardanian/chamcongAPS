<!DOCTYPE html>
<html lang="en" data-app-version="v-2025-11-04-mobile">
<head>
  <meta charset="utf-8" />
  <title>ChamCong / Shift Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <!-- Cache bust -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root{
      --bg:#f6f7fb; --panel:#ffffff; --muted:#6b7280; --txt:#0f172a;
      --green:#16a34a; --red:#dc2626; --yellow:#eab308; --gray:#9ca3af; --border:#e5e7eb;
      --card:#fafafa; --btn:#0f172a; --btnh:#111827; --btn-txt:#ffffff; --accent:#4f46e5;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font:14px system-ui, Segoe UI, Roboto, Arial, sans-serif;}

    .shell{min-height:100%; display:flex; align-items:center; justify-content:center; padding:24px;}
    .app{display:none;}
    .authed .shell{display:block; padding:16px;}
    .authed .app{display:grid; grid-template-columns: 360px 1fr; gap:16px; align-items:start}

    .card{background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 6px 24px rgba(15,23,42,.06);}
    h2,h3{margin:0 0 12px 0}
    .muted{color:var(--muted)}
    label{display:block;margin:8px 0 6px 0;font-weight:600}
    input,select,button{border:1px solid var(--border); color:var(--txt); border-radius:10px; padding:12px 14px; width:100%; font-size:14px; background:#fff;}
    button{background:var(--btn); color:var(--btn-txt); cursor:pointer; font-weight:700;}
    button:hover{background:var(--btnh)}
    button[disabled]{opacity:.6; cursor:not-allowed}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

    /* Table */
    .grid{overflow:auto;border:1px solid var(--border);border-radius:12px;background:#fff}
    .grid{ -webkit-overflow-scrolling: touch; }
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:820px}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);border-right:1px solid var(--border)}
    th:first-child, td:first-child{position:sticky;left:0;background:#fff;z-index:2}
    thead th{position:sticky;top:0;background:#fff;z-index:3}
    td.cell{cursor:pointer;text-align:center;font-weight:600;border-left:1px solid var(--border);height:44px}
    td.cell.disabled{cursor:not-allowed; opacity:.7}

    .legend{display:flex;gap:10px;flex-wrap:wrap}
    .dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:6px}
    .pill{display:inline-flex;gap:6px;align-items:center;background:var(--card);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .rightpane{display:grid;gap:12px}
    .toolbar{display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap}
    .note{font-size:12px;color:var(--muted)}
    .foot{font-size:12px;color:var(--muted);margin-top:8px}
    .login-card{width:100%; max-width:520px;}
    .error{color:#b91c1c; font-weight:600; margin-top:8px}
    .status{color:#475569; margin-top:8px}

    /* Sticky save bar inside the matrix card */
    .savebar{display:none; gap:8px; margin-top:8px; position:sticky; top:0; z-index:5;
      justify-content:flex-end; padding:8px; background:#ffffffcc; backdrop-filter:saturate(1.2) blur(2px);
      border:1px solid var(--border); border-radius:10px;}
    .savebar.show{display:flex;}
    .chip{background:#EEF2FF; color:#3730A3; border:1px solid #C7D2FE; padding:4px 8px; border-radius:999px; font-weight:700; font-size:12px;}

    /* Picker */
    .picker{position:fixed; z-index:9999; background:#fff; border:1px solid var(--border);
      border-radius:12px; box-shadow:0 12px 28px rgba(15,23,42,.18); padding:10px; display:none;}
    .picker .opt{display:inline-block; padding:8px 12px; margin:4px; border-radius:999px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:700; font-size:13px;}

    /* MOBILE */
    @media (max-width: 880px){
      body{font-size:16px;}
      .authed .app{grid-template-columns:1fr; gap:12px}
      .card{padding:12px; border-radius:12px;}
      .toolbar{gap:6px}
      table{min-width:640px}
      th,td{padding:8px 10px}
      td.cell{height:48px}
      .pill{padding:4px 8px}
      .legend{gap:6px}
      .savebar{top: env(safe-area-inset-top, 0px);}
      .foot{font-size:11px}
    }
  </style>
</head>
<body>
  <!-- Login -->
  <div class="shell" id="shell">
    <div class="card login-card">
      <h2>Shift Registration</h2>

      <div id="classicLogin">
        <label>User ID (your <em>pname</em>)</label>
        <input id="uid" type="text" autocomplete="off" placeholder="e.g., Bùi Quang Minh"/>
        <label>Password (your <em>person_id</em>)</label>
        <input id="pwd" type="password" autocomplete="new-password" placeholder="Enter your person_id"/>
        <button id="loginBtn" type="button" style="margin-top:10px" onclick="login()">Sign in</button>
        <div id="loginMsg" class="status" aria-live="polite"></div>
      </div>

      <div style="text-align:center; margin:10px 0; color:#94a3b8">— or —</div>

      <div style="text-align:center">
        <button type="button" onclick="loginWithGoogle()" style="background:#fff;color:#111827;border:1px solid var(--border)">
          Sign in with Google (student.vgu.edu.vn)
        </button>
      </div>
    </div>
  </div>

  <!-- App -->
  <div class="app" id="app" style="display:none">
    <div class="card">
      <h3>Controls</h3>
      <div style="display:grid;grid-template-columns:max-content 1fr;gap:8px;margin-top:8px">
        <div>Signed in:</div><div id="who"></div>
        <div>Role:</div><div id="role"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button type="button" onclick="logout()" style="background:#fff;color:#111827;border:1px solid var(--border)">Logout</button>
      </div>
      <hr/>
      <div class="toolbar">
        <div>
          <label>Week starting (Mon)</label>
          <input id="weekStart" type="date" />
        </div>
        <button type="button" onclick="loadWeek()">Load Week</button>
      </div>
      <div style="margin:10px 0">
        <div class="legend">
          <span class="pill"><i class="dot" style="background:var(--green)"></i>REGISTERED</span>
          <span class="pill"><i class="dot" style="background:var(--red)"></i>BUSY</span>
          <span class="pill"><i class="dot" style="background:var(--yellow)"></i>BUSY + IN-ROOM</span>
          <span class="pill"><i class="dot" style="background:var(--gray)"></i>BLANK</span>
        </div>
      </div>
      <div id="adminBar" style="display:none;margin-top:8px">
        <div class="pill" style="gap:10px">
          <input id="adminOverride" type="checkbox" onchange="toggleAdminEdit(this.checked)" />
          <label for="adminOverride" style="margin:0">Admin Edit Mode (ignores deadline & lets everyone edit)</label>
        </div>
        <div class="row" style="margin-top:8px">
          <button type="button" onclick="sendMonthly()">Send Monthly Reminders</button>
        </div>
      </div>
      <p class="foot">Deadline: Registration for <b>next week</b> closes at <b>Sunday 23:59</b> (local). After that, members can view but cannot modify. Turn on Admin Edit Mode to let everyone edit and ignore the deadline.</p>
    </div>

    <div class="rightpane">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3>Weekly Matrix</h3>
          <div class="savebar" id="savebar">
            <span class="chip" id="dirtyCount">0 pending</span>
            <button id="saveBtn" type="button" onclick="saveAll()" disabled>Save changes</button>
            <button type="button" onclick="discardAll()">Discard</button>
          </div>
        </div>

        <div id="grid" class="grid"></div>

        <p class="note">
          Y-axis: Names. X-axis: Days. Click to cycle (BLANK → REGISTERED → BUSY → BLANK).
          BUSY opens a subtype picker. When Admin Edit Mode is ON, everyone can edit.
        </p>
      </div>
    </div>
  </div>

  <!-- BUSY subtype picker -->
  <div id="picker" class="picker" onclick="event.stopPropagation()">
    <div>
      <span class="opt" data-sub="EXAM">EXAM</span>
      <span class="opt" data-sub="HOME">HOME</span>
      <span class="opt" data-sub="SICK">SICK</span>
      <span class="opt" data-sub="IN-ROOM">IN-ROOM</span>
      <span class="opt" data-sub="OTHER">OTHER</span>
    </div>
  </div>

<script>
let SESSION=null;
let CURRENT={days:[],users:[],data:{},colors:{},weekStartISO:null};
let STAGED={};
let PICKER_CTX=null;

function keyFor(u,d){return `${u}__${d}`;}
function updateSavebar(){
  const n=Object.keys(STAGED).length;
  document.getElementById('dirtyCount').textContent = `${n} pending`;
  document.getElementById('saveBtn').disabled = n===0;
  document.getElementById('savebar').classList.toggle('show', n>0);
}

/* -------- Login UI state -------- */
function setLoginState(isLoading,msg,isError){
  const btn=document.getElementById('loginBtn');
  const box=document.getElementById('loginMsg');
  btn.disabled=!!isLoading;
  btn.textContent=isLoading?'Signing in…':'Sign in';
  btn.setAttribute('aria-busy', isLoading ? 'true' : 'false');
  box.textContent=msg || (isLoading?'Logging in…':'');
  box.className=isError?'error':'status';
}

/* -------- Classic login -------- */
function login(){
  const user_key=document.getElementById('uid').value.trim();
  const password=document.getElementById('pwd').value;
  if(!user_key||!password){ setLoginState(false,'Please enter both User ID and Password.',true); return; }
  setLoginState(true,'Logging in…',false);

  google.script.run
    .withSuccessHandler(res=>{
      if(!res||!res.ok){ setLoginState(false,(res&&res.error)||'Login failed',true); return; }
      finishLogin(res.data);
    })
    .withFailureHandler(()=> setLoginState(false,'INVALID CREDENTIALS',true))
    .route({action:'login', user_key, password});
}

/* -------- Google login -------- */
function loginWithGoogle(){
  const btn = event?.target;
  if (btn) { btn.disabled = true; btn.textContent = 'Signing in…'; }
  google.script.run
    .withSuccessHandler(res=>{
      if (btn) { btn.disabled = false; btn.textContent = 'Sign in with Google (student.vgu.edu.vn)'; }
      if(!res||!res.ok){ alert((res&&res.error)||'Google sign-in failed'); return; }
      finishLogin(res.data);
    })
    .withFailureHandler(()=>{
      if (btn) { btn.disabled = false; btn.textContent = 'Sign in with Google (student.vgu.edu.vn)'; }
      alert('Google sign-in failed');
    })
    .route({action:'loginWithGoogle'});
}

function finishLogin(d){
  SESSION={user:d.user,is_admin:d.is_admin,admin_edit_override:!!d.admin_edit_override};
  document.body.classList.add('authed');
  document.getElementById('shell').style.display='none';
  document.getElementById('app').style.display='';
  document.getElementById('who').textContent = `${d.user.name} (${d.user.user_id})`;
  document.getElementById('role').textContent = d.is_admin ? 'Admin' : 'Member';
  if(d.is_admin){ document.getElementById('adminBar').style.display=''; document.getElementById('adminOverride').checked=!!d.admin_edit_override; }
  const today=new Date(); const monday=new Date(today.getFullYear(),today.getMonth(),today.getDate());
  const dow=monday.getDay(); monday.setDate(monday.getDate()+(dow===0?-6:1-dow));
  document.getElementById('weekStart').value=monday.toISOString().slice(0,10);
  loadWeek();
}

/* -------- Logout -------- */
function logout(){
  SESSION=null; STAGED={};
  document.getElementById('app').style.display='none';
  document.getElementById('shell').style.display='';
  document.body.classList.remove('authed');
  setLoginState(false,'',false);
  document.getElementById('uid').value='';
  document.getElementById('pwd').value='';
}

/* -------- Load week -------- */
function setGridLoading(on){
  document.getElementById('grid').innerHTML = on?'<div class="muted" style="padding:12px">Loading table…</div>':'';
}
function loadWeek(){
  STAGED={}; updateSavebar();
  const weekStartISO=document.getElementById('weekStart').value;
  setGridLoading(true);
  google.script.run.withSuccessHandler(res=>{
    setGridLoading(false);
    if(!res.ok){ document.getElementById('grid').innerHTML=`<div class="error" style="padding:12px">${res.error||'Failed to load'}</div>`; return; }
    CURRENT=res.data; renderGrid();
  }).route({action:'getWeek', weekStartISO});
}

/* -------- Grid render & interaction -------- */
function colorFor(status, subtype){
  status=(status||'').toUpperCase(); subtype=(subtype||'').toUpperCase();
  if(status==='REGISTERED') return 'var(--green)';
  if(status==='BUSY'&&subtype==='IN-ROOM') return 'var(--yellow)';
  if(status==='BUSY') return 'var(--red)';
  return 'var(--gray)';
}
function labelFor(status, subtype){
  status=(status||'').toUpperCase(); subtype=(subtype||'').toUpperCase();
  if(status==='OTHER'&&!subtype) return 'BLANK';
  if(status==='BUSY'&&subtype) return `BUSY (${subtype})`;
  return status||'BLANK';
}
function renderGrid(){
  const g=document.getElementById('grid');
  if(!CURRENT.days.length){ g.innerHTML='<div class="muted" style="padding:12px">No data</div>'; return; }

  let html='<table><thead><tr><th>Name</th>';
  CURRENT.days.forEach(d=> html+=`<th>${d}</th>`);
  html+='</tr></thead><tbody>';

  CURRENT.users.forEach(u=>{
    const isMine=SESSION?.user?.user_id===u.user_id;
    const everyoneCanEdit = document.getElementById('adminOverride').checked;
    html+=`<tr data-uid="${u.user_id}"><td><b>${u.name}</b></td>`;
    CURRENT.days.forEach(d=>{
      const k=keyFor(u.user_id,d);
      const stage=STAGED[k];
      const base=(CURRENT.data[u.user_id]||{})[d]||{status:'OTHER',subtype:''};
      const cell=stage||base;
      const bg=colorFor(cell.status,cell.subtype);
      const label=labelFor(cell.status,cell.subtype);
      const disabled = !(SESSION?.is_admin || isMine || everyoneCanEdit);
      const cls=disabled?'cell disabled':'cell';
      const handler=disabled?'':`onclick="onCellClick(event,'${u.user_id}','${d}')"`; 
      html+=`<td class="${cls}" style="background:${bg}" ${handler}>${label}</td>`;
    });
    html+='</tr>';
  });

  html+='</tbody></table>';
  g.innerHTML=html;
}

/* -------- Click cycle: BLANK → REGISTERED → BUSY → BLANK -------- */
function onCellClick(ev, user_id, dateISO) {
  ev.stopPropagation();
  hidePicker();

  const k = keyFor(user_id, dateISO);
  const base  = (CURRENT.data[user_id] || {})[dateISO] || {status:'OTHER', subtype:''};
  const cur   = STAGED[k] || base;
  const s = (cur.status || '').toUpperCase();

  if (s === 'OTHER') {
    STAGED[k] = { target_user_id:user_id, dateISO, status:'REGISTERED', subtype:'' };
    renderGrid(); updateSavebar();
  } else if (s === 'REGISTERED') {
    PICKER_CTX = { user_id, dateISO };
    openPicker(ev.clientX, ev.clientY);
  } else { // BUSY of any subtype → BLANK
    STAGED[k] = { target_user_id:user_id, dateISO, status:'OTHER', subtype:'' };
    renderGrid(); updateSavebar();
  }
}

/* Picker (for BUSY subtypes) with viewport clamping */
function openPicker(x,y){
  const p=document.getElementById('picker');
  const pad=8, w=220, h=p.offsetHeight||140;
  let left = x + pad, top = y + pad;
  const vw = window.innerWidth, vh = window.innerHeight;
  if (left + w > vw - pad) left = vw - w - pad;
  if (top + h > vh - pad) top = vh - h - pad;
  p.style.display='block'; p.style.left=left+'px'; p.style.top=top+'px';
}
function hidePicker(){document.getElementById('picker').style.display='none'; PICKER_CTX=null;}
document.addEventListener('click', hidePicker);
document.querySelectorAll('#picker .opt').forEach(el=>{
  el.addEventListener('click', ()=>{
    if(!PICKER_CTX) return;
    const subtype=el.getAttribute('data-sub'); const {user_id,dateISO}=PICKER_CTX;
    const k=keyFor(user_id,dateISO);
    STAGED[k]={target_user_id:user_id,dateISO,status:'BUSY',subtype};
    hidePicker(); renderGrid(); updateSavebar();
  });
});

/* Save / Discard */
function saveAll(){
  const changes=Object.values(STAGED);
  if(!changes.length) return;
  const btn=document.getElementById('saveBtn');
  btn.disabled=true; btn.textContent='Saving…';
  const actor_id=SESSION?.user?.user_id;

  google.script.run.withSuccessHandler(res=>{
    btn.textContent='Save changes';
    if(!res.ok){ alert(res.error||'Save failed'); btn.disabled=false; return; }
    changes.forEach(c=>{
      CURRENT.data[c.target_user_id]=CURRENT.data[c.target_user_id]||{};
      CURRENT.data[c.target_user_id][c.dateISO]={status:c.status, subtype:c.subtype};
    });
    STAGED={}; updateSavebar(); renderGrid();
  }).route({action:'setStatusBatch', actor_id, changes});
}
function discardAll(){ STAGED={}; updateSavebar(); renderGrid(); }

/* Admin toggle mirrors server */
function toggleAdminEdit(on){
  const me=SESSION?.user?.user_id;
  google.script.run.withSuccessHandler(res=>{
    if(!res.ok){ alert(res.error||'Failed'); return; }
    renderGrid();
  }).route({action:'toggleAdminEdit', actor_id: me, on: !!on});
}

/* Monthly reminders (manual trigger) */
function sendMonthly(){
  const ym=prompt('Send reminders for YYYY-MM (leave blank to send for previous month):','');
  let year=null,month=null; if(ym&&/^\d{4}-\d{2}$/.test(ym)){year=+ym.slice(0,4);month=+ym.slice(5);}
  const btns=document.querySelectorAll('button'); btns.forEach(b=>b.disabled=true);
  google.script.run.withSuccessHandler(res=>{
    btns.forEach(b=>b.disabled=false);
    if(!res.ok){ alert(res.error||'Failed'); return; }
    alert(res.data.message||'Done');
  }).route({action:'sendMonthlyReminders', year, month});
}
</script>
</body>
</html>
